
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../recipes/">
      
      
        <link rel="next" href="../theory/how_we_got_here/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.7">
    
    
      
        <title>Reference - Cadwyn</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.f2e4d321.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#reference" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Cadwyn" class="md-header__button md-logo" aria-label="Cadwyn" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Cadwyn
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Reference
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1M8 13h8v-2H8v2m9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1 0 1.71-1.39 3.1-3.1 3.1h-4V17h4a5 5 0 0 0 5-5 5 5 0 0 0-5-5Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5M7 15a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/zmievsa/cadwyn" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Cadwyn
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href=".." class="md-tabs__link">
          
  
    
  
  Home

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../tutorial/" class="md-tabs__link">
        
  
    
  
  Tutorial

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../recipes/" class="md-tabs__link">
        
  
    
  
  Recipes

      </a>
    </li>
  

      
        
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href="./" class="md-tabs__link">
        
  
    
  
  Reference

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../theory/how_we_got_here/" class="md-tabs__link">
          
  
    
  
  Theory

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Cadwyn" class="md-nav__button md-logo" aria-label="Cadwyn" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Cadwyn
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/zmievsa/cadwyn" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Cadwyn
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href=".." class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Home
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_1" id="__nav_1_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Home
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../home/CONTRIBUTING/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contributing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../home/CHANGELOG/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Changelog
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tutorial
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../recipes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Recipes
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Reference
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Reference
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pydantic" class="md-nav__link">
    <span class="md-ellipsis">
      Pydantic
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cadwyns-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Cadwyn's flow
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Cadwyn's flow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#service-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Service structure
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#main-app" class="md-nav__link">
    <span class="md-ellipsis">
      Main App
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Main App">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#routing" class="md-nav__link">
    <span class="md-ellipsis">
      Routing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Routing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#versionedapirouter" class="md-nav__link">
    <span class="md-ellipsis">
      VersionedAPIRouter
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cli" class="md-nav__link">
    <span class="md-ellipsis">
      CLI
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#code-generation" class="md-nav__link">
    <span class="md-ellipsis">
      Code generation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Code generation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#function-interface" class="md-nav__link">
    <span class="md-ellipsis">
      Function interface
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cli-interface" class="md-nav__link">
    <span class="md-ellipsis">
      CLI interface
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CLI interface">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#note" class="md-nav__link">
    <span class="md-ellipsis">
      Note
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#version-changes" class="md-nav__link">
    <span class="md-ellipsis">
      Version Changes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Version Changes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#versionchange" class="md-nav__link">
    <span class="md-ellipsis">
      VersionChange
    </span>
  </a>
  
    <nav class="md-nav" aria-label="VersionChange">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#versionchange__name__" class="md-nav__link">
    <span class="md-ellipsis">
      VersionChange.__name__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#versionchangedescription" class="md-nav__link">
    <span class="md-ellipsis">
      VersionChange.description
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#versionchangeinstructions_to_migrate_to_previous_version" class="md-nav__link">
    <span class="md-ellipsis">
      VersionChange.instructions_to_migrate_to_previous_version
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-migrations" class="md-nav__link">
    <span class="md-ellipsis">
      Data migrations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Data migrations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#path-based-migration-specification" class="md-nav__link">
    <span class="md-ellipsis">
      Path-based migration specification
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-of-non-body-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Migration of non-body attributes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#internal-representations" class="md-nav__link">
    <span class="md-ellipsis">
      Internal representations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#internal-request-body-representations" class="md-nav__link">
    <span class="md-ellipsis">
      Internal request body representations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#streamingresponse-and-fileresponse-migrations" class="md-nav__link">
    <span class="md-ellipsis">
      StreamingResponse and FileResponse migrations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pydantic-2-rootmodel-migration-warning" class="md-nav__link">
    <span class="md-ellipsis">
      Pydantic 2 RootModel migration warning
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#versionbundle" class="md-nav__link">
    <span class="md-ellipsis">
      VersionBundle
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#endpoints" class="md-nav__link">
    <span class="md-ellipsis">
      Endpoints
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Endpoints">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#defining-endpoints-that-didnt-exist-in-new-versions" class="md-nav__link">
    <span class="md-ellipsis">
      Defining endpoints that didn't exist in new versions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#defining-endpoints-that-didnt-exist-in-old-versions" class="md-nav__link">
    <span class="md-ellipsis">
      Defining endpoints that didn't exist in old versions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#changing-endpoint-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Changing endpoint attributes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dealing-with-endpoint-duplicates" class="md-nav__link">
    <span class="md-ellipsis">
      Dealing with endpoint duplicates
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#enums" class="md-nav__link">
    <span class="md-ellipsis">
      Enums
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Enums">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adding-enum-members" class="md-nav__link">
    <span class="md-ellipsis">
      Adding enum members
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#removing-enum-members" class="md-nav__link">
    <span class="md-ellipsis">
      Removing enum members
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#schemas" class="md-nav__link">
    <span class="md-ellipsis">
      Schemas
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Schemas">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#add-a-field" class="md-nav__link">
    <span class="md-ellipsis">
      Add a field
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remove-a-field" class="md-nav__link">
    <span class="md-ellipsis">
      Remove a field
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#change-a-field" class="md-nav__link">
    <span class="md-ellipsis">
      Change a field
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Change a field">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#defaults-warning" class="md-nav__link">
    <span class="md-ellipsis">
      DEFAULTS WARNING
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-a-validator" class="md-nav__link">
    <span class="md-ellipsis">
      Add a validator
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remove-a-validator" class="md-nav__link">
    <span class="md-ellipsis">
      Remove a validator
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rename-a-schema" class="md-nav__link">
    <span class="md-ellipsis">
      Rename a schema
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules" class="md-nav__link">
    <span class="md-ellipsis">
      Modules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#version-changes-with-side-effects" class="md-nav__link">
    <span class="md-ellipsis">
      Version changes with side effects
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#api-version-header-and-context-variables" class="md-nav__link">
    <span class="md-ellipsis">
      API Version header and context variables
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Theory
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Theory
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../theory/how_we_got_here/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How we got here
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../theory/literature/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Literature
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pydantic" class="md-nav__link">
    <span class="md-ellipsis">
      Pydantic
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cadwyns-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Cadwyn's flow
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Cadwyn's flow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#service-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Service structure
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#main-app" class="md-nav__link">
    <span class="md-ellipsis">
      Main App
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Main App">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#routing" class="md-nav__link">
    <span class="md-ellipsis">
      Routing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Routing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#versionedapirouter" class="md-nav__link">
    <span class="md-ellipsis">
      VersionedAPIRouter
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cli" class="md-nav__link">
    <span class="md-ellipsis">
      CLI
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#code-generation" class="md-nav__link">
    <span class="md-ellipsis">
      Code generation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Code generation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#function-interface" class="md-nav__link">
    <span class="md-ellipsis">
      Function interface
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cli-interface" class="md-nav__link">
    <span class="md-ellipsis">
      CLI interface
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CLI interface">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#note" class="md-nav__link">
    <span class="md-ellipsis">
      Note
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#version-changes" class="md-nav__link">
    <span class="md-ellipsis">
      Version Changes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Version Changes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#versionchange" class="md-nav__link">
    <span class="md-ellipsis">
      VersionChange
    </span>
  </a>
  
    <nav class="md-nav" aria-label="VersionChange">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#versionchange__name__" class="md-nav__link">
    <span class="md-ellipsis">
      VersionChange.__name__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#versionchangedescription" class="md-nav__link">
    <span class="md-ellipsis">
      VersionChange.description
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#versionchangeinstructions_to_migrate_to_previous_version" class="md-nav__link">
    <span class="md-ellipsis">
      VersionChange.instructions_to_migrate_to_previous_version
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-migrations" class="md-nav__link">
    <span class="md-ellipsis">
      Data migrations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Data migrations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#path-based-migration-specification" class="md-nav__link">
    <span class="md-ellipsis">
      Path-based migration specification
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-of-non-body-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Migration of non-body attributes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#internal-representations" class="md-nav__link">
    <span class="md-ellipsis">
      Internal representations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#internal-request-body-representations" class="md-nav__link">
    <span class="md-ellipsis">
      Internal request body representations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#streamingresponse-and-fileresponse-migrations" class="md-nav__link">
    <span class="md-ellipsis">
      StreamingResponse and FileResponse migrations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pydantic-2-rootmodel-migration-warning" class="md-nav__link">
    <span class="md-ellipsis">
      Pydantic 2 RootModel migration warning
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#versionbundle" class="md-nav__link">
    <span class="md-ellipsis">
      VersionBundle
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#endpoints" class="md-nav__link">
    <span class="md-ellipsis">
      Endpoints
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Endpoints">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#defining-endpoints-that-didnt-exist-in-new-versions" class="md-nav__link">
    <span class="md-ellipsis">
      Defining endpoints that didn't exist in new versions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#defining-endpoints-that-didnt-exist-in-old-versions" class="md-nav__link">
    <span class="md-ellipsis">
      Defining endpoints that didn't exist in old versions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#changing-endpoint-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Changing endpoint attributes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dealing-with-endpoint-duplicates" class="md-nav__link">
    <span class="md-ellipsis">
      Dealing with endpoint duplicates
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#enums" class="md-nav__link">
    <span class="md-ellipsis">
      Enums
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Enums">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adding-enum-members" class="md-nav__link">
    <span class="md-ellipsis">
      Adding enum members
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#removing-enum-members" class="md-nav__link">
    <span class="md-ellipsis">
      Removing enum members
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#schemas" class="md-nav__link">
    <span class="md-ellipsis">
      Schemas
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Schemas">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#add-a-field" class="md-nav__link">
    <span class="md-ellipsis">
      Add a field
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remove-a-field" class="md-nav__link">
    <span class="md-ellipsis">
      Remove a field
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#change-a-field" class="md-nav__link">
    <span class="md-ellipsis">
      Change a field
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Change a field">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#defaults-warning" class="md-nav__link">
    <span class="md-ellipsis">
      DEFAULTS WARNING
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-a-validator" class="md-nav__link">
    <span class="md-ellipsis">
      Add a validator
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remove-a-validator" class="md-nav__link">
    <span class="md-ellipsis">
      Remove a validator
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rename-a-schema" class="md-nav__link">
    <span class="md-ellipsis">
      Rename a schema
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules" class="md-nav__link">
    <span class="md-ellipsis">
      Modules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#version-changes-with-side-effects" class="md-nav__link">
    <span class="md-ellipsis">
      Version changes with side effects
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#api-version-header-and-context-variables" class="md-nav__link">
    <span class="md-ellipsis">
      API Version header and context variables
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="reference">Reference<a class="headerlink" href="#reference" title="Permanent link">&para;</a></h1>
<h2 id="pydantic">Pydantic<a class="headerlink" href="#pydantic" title="Permanent link">&para;</a></h2>
<p>Cadwyn supports both Pydantic 1 and Pydantic 2 so you can pick your preferred version without any issue.</p>
<h2 id="cadwyns-flow">Cadwyn's flow<a class="headerlink" href="#cadwyns-flow" title="Permanent link">&para;</a></h2>
<p>Cadwyn aims to be the most accurate and sophisticated API Versioning model out there. First of all, you maintain <strong>zero</strong> duplicated code yourself. Usually, in API versioning you <a href="../theory/how_we_got_here/">would need to</a> duplicate and maintain at least some layer of your applicaton. It could be the database, business logic, schemas, and endpoints. Cadwyn only duplicates your:</p>
<ul>
<li>schemas but you do not maintain the duplicates -- you only regenerate it when necessary</li>
<li>endpoints but only in runtime so you do not need to maintain the duplicates</li>
</ul>
<p>You define your database, business logic, routes, and schemas only once. Then, whenever you release a new API version, you use Cadwyn's <a href="#version-changes">version change DSL</a> to describe how to convert your app to the previous version. So your business logic and database stay intact and always represent the latest version while the version changes make sure that your clients can continue using the previous versions without ever needing to update their code.</p>
<h3 id="service-structure">Service structure<a class="headerlink" href="#service-structure" title="Permanent link">&para;</a></h3>
<p>The service structure with Cadwyn is fairly straighforward. See the <a href="https://github.com/zmievsa/cadwyn/tree/main/tests/tutorial">example service</a> or follow the steps above:</p>
<ol>
<li>Define a <a href="#versionbundle">VersionBundle</a> where you add your first version.</li>
<li>Create a <code>data/latest</code> directory and add your latest version of schemas there. This will serve as a template directory for future code generation.</li>
<li>Run <a href="#code-generation">code generation</a> that will create generated versions of your <code>latest</code> directory next to it.</li>
<li>Create a <a href="#main-app">Cadwyn app</a> that you will use instead of <code>FastAPI</code>. Pass imported <code>data/latest</code> and your <code>VersonBundle</code> to it.</li>
<li>Create a <a href="#versionedapirouter">VersionedAPIRouter</a> that you will use for defining your versioned routes.</li>
<li><a href="#main-app">Include this router</a> and any other versioned routers into your <code>Cadwyn</code> app. It will duplicate your router in runtime for each API version.</li>
</ol>
<p>The recommended directory structure for cadwyn is as follows:</p>
<div class="highlight"><pre><span></span><code>├── data
│   ├── __init__.py
│   ├── unversioned
│   │   ├── __init__.py
│   │   └── users.py
│   └── latest          # The latest version of your schemas goes here
│       ├── __init__.py
│       └── users.py
└── versions
    ├── __init__.py     # Your version bundle goes here
    └── v2001_01_01.py  # Your version changes go here
</code></pre></div>
<p>You can structure your business logic, database, and all other parts of your application in any way you like.</p>
<p>That's it! Your service is ready to be versioned. We can now use the most powerful feature of Cadwyn: <a href="#version-changes">version changes</a>.</p>
<h2 id="main-app">Main App<a class="headerlink" href="#main-app" title="Permanent link">&para;</a></h2>
<p>Cadwyn's standard usage is done with a single customized FastAPI app: <code>cadwyn.Cadwyn</code>. It accepts all the same arguments as <code>FastAPI</code> three more keyword-only arguments:</p>
<ul>
<li>Required <code>versions: VersionBundle</code> describes <a href="#versionbundle">all versions</a> within your application</li>
<li>Required <code>latest_schemas_package: ModuleType</code> is your <a href="#service-structure">latest package</a> that contains the latest versions of your versioned schemas</li>
<li>Optional <code>api_version_header_name: str = "x-api-version"</code> is the header that Cadwyn will use for <a href="#routing">routing</a> to different API versions of your app</li>
</ul>
<p>After you have defined a main app, you can add versioned API routers to it using <code>Cadwyn.generate_and_include_versioned_routers(*routers)</code></p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">cadwyn</span> <span class="kn">import</span> <span class="n">VersionedAPIRouter</span><span class="p">,</span> <span class="n">Cadwyn</span>
<span class="kn">from</span> <span class="nn">versions</span> <span class="kn">import</span> <span class="n">my_version_bundle</span>
<span class="kn">from</span> <span class="nn">data</span> <span class="kn">import</span> <span class="n">latest</span>


<span class="n">router</span> <span class="o">=</span> <span class="n">VersionedAPIRouter</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;/users&quot;</span><span class="p">)</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">])</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">read_users</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;Rick&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;Morty&quot;</span><span class="p">}]</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/</span><span class="si">{username}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">])</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">read_user</span><span class="p">(</span><span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">username</span><span class="p">}</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Cadwyn</span><span class="p">(</span><span class="n">versions</span><span class="o">=</span><span class="n">my_version_bundle</span><span class="p">,</span> <span class="n">latest_schemas_package</span><span class="o">=</span><span class="n">latest</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">generate_and_include_versioned_routers</span><span class="p">(</span><span class="n">router</span><span class="p">)</span>
</code></pre></div>
<p>That's it! <code>generate_and_include_versioned_routers</code> will generate all versions of your routers based on the <code>versions</code> argument and will use schemas from the versioned schema directories parallel to <code>latest_schema_package</code>.</p>
<h3 id="routing">Routing<a class="headerlink" href="#routing" title="Permanent link">&para;</a></h3>
<p>Cadwyn is built on header-based routing. First, we route requests to the appropriate API version based on the version header (<code>x-api-version</code> by default). Then we route by the appropriate url path and method. Currerntly, Cadwyn only works with ISO date-based versions (such as <code>2022-11-16</code>). If the user sends an incorrect API version, Cadwyn picks up the closest lower applicable version. For example, <code>2022-11-16</code> in request can be matched by <code>2022-11-15</code> and <code>2000-01-01</code> but cannot be matched by <code>2022-11-17</code>. See more details in <a href="https://github.com/team-monite/verselect">verselect</a>.</p>
<p>However, header-based routing is only the standard way to use Cadwyn. If you want to use any other sort of routing, you can use Cadwyn directly through <code>cadwyn.generate_versioned_routers</code>. Just remember to update the <code>VersionBundle.api_version_var</code> variable each time you route some request to a version. This variable allows Cadwyn to do <a href="#version-changes-with-side-effects">side effects</a> and <a href="#data-migrations">data migrations</a>.</p>
<h4 id="versionedapirouter">VersionedAPIRouter<a class="headerlink" href="#versionedapirouter" title="Permanent link">&para;</a></h4>
<p>Cadwyn has its own API Router class: <code>cadwyn.VersionedAPIRouter</code>. You are free to use a regular <code>fastapi.APIRouter</code> but <code>cadwyn.VersionedAPIRouter</code> has a special decorator <code>only_exists_in_older_versions(route)</code> which allows you to define routes that have been previously deleted. First you define the route and than add this decorator to it.</p>
<h2 id="cli">CLI<a class="headerlink" href="#cli" title="Permanent link">&para;</a></h2>
<p>Cadwyn has an optional CLI interface that can be installed with <code>pip install cadwyn[cli]</code>.
Run <code>cadwyn --version</code> to check current version of Cadwyn.</p>
<h2 id="code-generation">Code generation<a class="headerlink" href="#code-generation" title="Permanent link">&para;</a></h2>
<p>Cadwyn generates versioned schemas and everything related to them from latest version. These versioned schemas will be automatically used in requests and responses for <a href="#main-app">versioned API routes</a>. There are two methods of generating code: using a function and using the CLI:</p>
<h3 id="function-interface">Function interface<a class="headerlink" href="#function-interface" title="Permanent link">&para;</a></h3>
<p>You can use <code>cadwyn.generate_code_for_versioned_packages</code> which accepts a <code>template_module</code> (a directory which contains the latest versions) and <code>versions</code> which is the <code>VersionBundle</code> from which to generate versions.</p>
<h3 id="cli-interface">CLI interface<a class="headerlink" href="#cli-interface" title="Permanent link">&para;</a></h3>
<p>The interface is the same to the function one and is a shorthand for simple cases:</p>
<ul>
<li><code>cadwyn generate-code-for-versioned-packages path.to.latest.package path.to.version.bundle:my_version_bundle</code></li>
<li><code>cadwyn generate-code-for-versioned-packages path.to.latest.package path.to.version.bundle:func_that_returns_version_bundle</code></li>
</ul>
<h4 id="note"><strong>Note</strong><a class="headerlink" href="#note" title="Permanent link">&para;</a></h4>
<ul>
<li>You don't use the system path style for both arguments. Instead, imagine that you are importing these modules in python -- that's the way you want to write down the paths.</li>
<li>Take a look at how we point to our version bundle. We use ":" to say that it's a variable within the specified module</li>
</ul>
<h2 id="version-changes">Version Changes<a class="headerlink" href="#version-changes" title="Permanent link">&para;</a></h2>
<p>Version changes are the backbone of Cadwyn. They give you an ability to describe things like "This field in that schema had a different name in an older version" or "this endpoint was deleted in the latest version". Whenever add a new version, it means that you wish to make a bunch of breaking changes in your API without affecting your users.</p>
<p>First, you apply the breaking changes to your schemas and endpoints. In Cadwyn, you always work on the <strong>latest</strong> version of your application so you change your schemas first, just like you would do in an app without API Versioning.</p>
<p>Second, you need to gather your breaking changes into groups. Let's say that you want to rename the field "creation_date" into "created_at" but you also want to delete the endpoint "GET /v1/tax_ids": these changes are unrelated so they should be put into different groups. On the other hand, deletion of "POST /v1/tax_ids" endpoint should go into the same group as its <em>GET</em> counterpart. These groups are very important to make the changes easily understandable for both your users and your developers.</p>
<p>Then, you describe each group with a version change:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># versions/v2023_02_10.py</span>

<span class="kn">from</span> <span class="nn">cadwyn.structure</span> <span class="kn">import</span> <span class="n">VersionChange</span><span class="p">,</span> <span class="n">endpoint</span>


<span class="k">class</span> <span class="nc">RemoveTaxIDEndpoints</span><span class="p">(</span><span class="n">VersionChange</span><span class="p">):</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Remove `GET /v1/tax_ids` and `POST /v1/tax_ids` endpoints&quot;</span>
    <span class="n">instructions_to_migrate_to_previous_version</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">endpoint</span><span class="p">(</span><span class="s2">&quot;/v1/tax_ids&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">existed</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
<p>Then you add your version change class(es) into your version bundle to activate it:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># versions/__init__.py</span>

<span class="kn">from</span> <span class="nn">cadwyn.structure</span> <span class="kn">import</span> <span class="n">VersionBundle</span><span class="p">,</span> <span class="n">Version</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>

<span class="kn">from</span> <span class="nn">.v2023_02_10</span> <span class="kn">import</span> <span class="n">RemoveTaxIDEndpoints</span>


<span class="n">versions</span> <span class="o">=</span> <span class="n">VersionBundle</span><span class="p">(</span>
    <span class="n">Version</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2023</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">RemoveTaxIDEndpoints</span><span class="p">),</span>
    <span class="n">Version</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">16</span><span class="p">)),</span>
<span class="p">)</span>
</code></pre></div>
<p>Now let's discuss what each of these parts does and why:</p>
<h3 id="versionchange">VersionChange<a class="headerlink" href="#versionchange" title="Permanent link">&para;</a></h3>
<p><code>VersionChange</code> classes describe each atomic group of business capabilities that you have altered in a version.</p>
<h4 id="versionchange__name__">VersionChange.__name__<a class="headerlink" href="#versionchange__name__" title="Permanent link">&para;</a></h4>
<p>The name of the version change, <code>RemoveTaxIDEndpoints</code>, describes what breaking change has happened. It must be a verb and it is the best resource for your new developers to quickly understand what happened between the versions. Do not be shy to use really long names -- it is better to have a long name than to create a misunderstanding. Avoid generic names such as <code>RefactorUserFields</code>. Better have an ugly name such as <code>RenameCreationDatetimeAndUpdateDatetimeToCreatedAtAndUpdatedAt</code> then to have a generic name such as <code>RefactorFields</code>. Because after just a few of such version changes, your versioning structure can become completely unreadable:</p>
<div class="highlight"><pre><span></span><code><span class="n">versions</span> <span class="o">=</span> <span class="n">VersionBundle</span><span class="p">(</span>
    <span class="n">Version</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2023</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="n">ChangeCreateLogic</span><span class="p">,</span> <span class="n">AddRequiredFields</span><span class="p">),</span>
    <span class="n">Version</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2023</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">DeleteEndpoint</span><span class="p">,</span> <span class="n">ChangeFields</span><span class="p">,</span> <span class="n">RenameFields</span><span class="p">),</span>
    <span class="n">Version</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2023</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">RenameEndpoints</span><span class="p">,</span> <span class="n">RefactorFields</span><span class="p">),</span>
    <span class="n">Version</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">16</span><span class="p">)),</span>
<span class="p">)</span>
</code></pre></div>
<h4 id="versionchangedescription">VersionChange.description<a class="headerlink" href="#versionchangedescription" title="Permanent link">&para;</a></h4>
<p>The description field of your version change must be even more detailed. In fact, it is intended to be the <strong>name</strong> and the <strong>summary</strong> of the version change for your clients. It must clearly state to you clients <strong>what happened</strong> and <strong>why</strong>. So you need to make it grammatically correct, detailed, concrete, and written for humans. Note that you do not have to use a strict machine-readable format -- it is a portion of documentation, not a set of intructions. Let's take <a href="https://stripe.com/blog/api-versioning">Stripe's description</a> to one of their version changes as an example:</p>
<div class="highlight"><pre><span></span><code>Event objects (and webhooks) will now render <span class="sb">`request`</span> subobject that contains a request ID and idempotency key instead of just a string request ID.
</code></pre></div>
<p>It is concise, descriptive, and human-readable -- just like any good documentation. Now let's look at the bad description:</p>
<div class="highlight"><pre><span></span><code>Migration from first version (2022-11-16) to 2023-09-01 version.
Changes:
<span class="k">*</span><span class="w"> </span>Changed schema for &#39;POST /v1/tax_ids&#39; endpoint
</code></pre></div>
<ul>
<li>Its first line, <code>Migration from first version (2022-11-16) to 2023-09-01 version.</code>, duplicates the already-known information -- your developers will know which version <code>VersionChange</code> migrates to and from by its location in <a href="#versionbundle">VersionBundle</a> and most likely by its file name. Your clients will also know that because you can automatically infer this information from  So it is simply standing in the way of actually useful parts of the documentation</li>
<li>Its second line, <code>Changes:</code>, does not make any sense as well because description of a <code>VersionChange</code> cannot describe anything but changes. So again, it's stating the obvious and making it harder for our readers to understand the crux of the change</li>
<li>Its third line, <code>Changed schema for 'POST /v1/tax_ids' endpoint</code>, gives both too much and too little information. First of all, it talks about changing schema but it never mentions what exactly changed. Remember: we are doing this to make it easy for our clients to migrate from one version to another. Insteaad, it is much better to mention the openapi model name that you changed, the fields you changed, and why you changed them</li>
</ul>
<h4 id="versionchangeinstructions_to_migrate_to_previous_version">VersionChange.instructions_to_migrate_to_previous_version<a class="headerlink" href="#versionchangeinstructions_to_migrate_to_previous_version" title="Permanent link">&para;</a></h4>
<p>In Cadwyn, you use the latest version. This attribute is a way for you to describe how your schemas and endpoints looked in previous versions so that Cadwyn can guess code generation and route generation to recreate the old schemas and endpoints for your clients. So you only need to maintain your latest schemas and your migrations while Cadwyn takes care of the rest. In fact, you spend barely any effort on <strong>maintaining</strong> your migrations because they are effectively immutable -- they describe the breaking changes that happened in the past so there is no need to ever change them.</p>
<p>This approach of <em>maintaining the present and describing the past</em> might appear weird. You just need to form the correct mindset which is counter-intuitive at first but after just one or two attempts at versioning you will see how much sense this approach makes.</p>
<h4 id="data-migrations">Data migrations<a class="headerlink" href="#data-migrations" title="Permanent link">&para;</a></h4>
<p>Let's say that we renamed the field <code>creation_date</code> into <code>created_at</code>. We have altered our schemas -- that's great! But when our clients send us requests using the old versions of our API -- we will still get the data where we have <code>creation_date</code> instead of <code>created_at</code>. How do we solve this? Well, in Cadwyn your business logic never receives requests of the old versions. Instead, it receives only the requests of the latest version. So when you define a version change that renames a field, you need to also define how to convert the request body from the old version to the newer version. For example:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">cadwyn.structure</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">VersionChange</span><span class="p">,</span>
    <span class="n">schema</span><span class="p">,</span>
    <span class="n">convert_request_to_next_version_for</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">data.latest.invoices</span> <span class="kn">import</span> <span class="n">InvoiceCreateRequest</span>


<span class="k">class</span> <span class="nc">RemoveTaxIDEndpoints</span><span class="p">(</span><span class="n">VersionChange</span><span class="p">):</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Rename `Invoice.creation_date` into `Invoice.created_at`.&quot;</span>
    <span class="n">instructions_to_migrate_to_previous_version</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">schema</span><span class="p">(</span><span class="n">InvoiceCreateRequest</span><span class="p">)</span>
        <span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s2">&quot;creation_date&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">had</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;created_at&quot;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="nd">@convert_request_to_next_version_for</span><span class="p">(</span><span class="n">InvoiceCreateRequest</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">rename_creation_date_into_created_at</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">RequestInfo</span><span class="p">):</span>
        <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="s2">&quot;created_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;creation_date&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Notice how we specified the schema for <code>InvoiceCreateRequest</code> in our migration? This will signal to Cadwyn to apply it to all routes that have this schema as their body.</p>
<p>Now we have not only described how schemas changed but we have also described how to migrate a request of the old version to the new version. When Cadwyn receives a request of a particular version, the request is first validated against the schema of that particular version. Then Cadwyn applies all request migrations until the latest version to migrate the request to latest. So now your business logic receives the latest version of the request yet for your clients you have two versions of your API -- you have added variability without introducing any complexity into your business logic.</p>
<p>But wait.. What happens with the <code>Invoice</code> responses? Your business logic will now return <code>created_at</code> so your clients from old versions will be affected! Cadwyn has a tool for that too: we migrate our responses as well. Requests were migrated forward in versions but responses are migrated backward in versions! So your business logic returns a response of the latest version and Cadwyn will use your response migrations to migrate it back the version of your client's request:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">cadwyn.structure</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">VersionChange</span><span class="p">,</span>
    <span class="n">schema</span><span class="p">,</span>
    <span class="n">convert_request_to_next_version_for</span><span class="p">,</span>
    <span class="n">convert_response_to_previous_version_for</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">data.latest.invoices</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BaseInvoice</span><span class="p">,</span>
    <span class="n">InvoiceCreateRequest</span><span class="p">,</span>
    <span class="n">InvoiceResource</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">RemoveTaxIDEndpoints</span><span class="p">(</span><span class="n">VersionChange</span><span class="p">):</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Rename `Invoice.creation_date` into `Invoice.created_at`.&quot;</span>
    <span class="n">instructions_to_migrate_to_previous_version</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">schema</span><span class="p">(</span><span class="n">BaseInvoice</span><span class="p">)</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s2">&quot;creation_date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">had</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;created_at&quot;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="nd">@convert_request_to_next_version_for</span><span class="p">(</span><span class="n">InvoiceCreateRequest</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">rename_creation_date_into_created_at</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">RequestInfo</span><span class="p">):</span>
        <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="s2">&quot;created_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;creation_date&quot;</span><span class="p">)</span>

    <span class="nd">@convert_response_to_previous_version_for</span><span class="p">(</span><span class="n">InvoiceResource</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">rename_created_at_into_creation_date</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">ResponseInfo</span><span class="p">):</span>
        <span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="s2">&quot;creation_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;created_at&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Notice how we specified the schema for <code>InvoiceResource</code> in our migration? This will signal to Cadwyn to apply it to all routes that have this schema as their <code>response_model</code>. Notice also that we now use <code>BaseInvoice</code> in our instructions -- let's imagine that it is the parent of both <code>InvoiceCreateRequest</code> and <code>InvoiceResource</code> so renaming it there will rename it in these schemas as well. You can, however, apply the instructions to both individual schemas instead of their parent if you want to.</p>
<p>Now our request comes, Cadwyn migrates it to the latest version using our request migration, then we do our business logic, return the latest response from it, and Cadwyn migrates it back to the request version. Does our business logic or database know about the fact that we have two versions? No, not at all! It is zero-cost. Imagine how beneficial it is when you support not two but two hundred versions.</p>
<p><img alt="The diagram showing how it works" src="../img/simplified_migration_model.png" /></p>
<p><strong>Notice</strong> how we used the <strong>latest</strong> versions of our schemas in our migration -- this pattern can be found everywhere in Cadwyn. You use the latest version of your schemas to describe what happened to all other versions because other versions might not exist when you are defining migrations for them.</p>
<h5 id="path-based-migration-specification">Path-based migration specification<a class="headerlink" href="#path-based-migration-specification" title="Permanent link">&para;</a></h5>
<p>Oftentimes you will need to migrate not based on the request body or response model but based on the path of the endpoint. This happens when, for example, endpoint does not have a request body or its response model is used in other places that we do not want to migrate. Let's pick the example <a href="#data-migrations">above</a> and use paths instead of schemas:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">cadwyn.structure</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">VersionChange</span><span class="p">,</span>
    <span class="n">schema</span><span class="p">,</span>
    <span class="n">convert_request_to_next_version_for</span><span class="p">,</span>
    <span class="n">convert_response_to_previous_version_for</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">data.latest.invoices</span> <span class="kn">import</span> <span class="n">BaseInvoice</span>


<span class="k">class</span> <span class="nc">RemoveTaxIDEndpoints</span><span class="p">(</span><span class="n">VersionChange</span><span class="p">):</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Rename `Invoice.creation_date` into `Invoice.created_at`.&quot;</span>
    <span class="n">instructions_to_migrate_to_previous_version</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">schema</span><span class="p">(</span><span class="n">BaseInvoice</span><span class="p">)</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s2">&quot;creation_date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">had</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;created_at&quot;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="nd">@convert_request_to_next_version_for</span><span class="p">(</span><span class="s2">&quot;/v1/invoices&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">rename_creation_date_into_created_at</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">RequestInfo</span><span class="p">):</span>
        <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="s2">&quot;created_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;creation_date&quot;</span><span class="p">)</span>

    <span class="nd">@convert_response_to_previous_version_for</span><span class="p">(</span><span class="s2">&quot;/v1/invoices&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">rename_created_at_into_creation_date</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">ResponseInfo</span><span class="p">):</span>
        <span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="s2">&quot;creation_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;created_at&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Though I highly recommend you to stick to schemas as it is much easier to introduce inconsistencies when using paths; for example, when you have 10 endpoints with the same response body schema but you forgot to add migrations for 3 of them because you use paths instead of schemas.</p>
<h5 id="migration-of-non-body-attributes">Migration of non-body attributes<a class="headerlink" href="#migration-of-non-body-attributes" title="Permanent link">&para;</a></h5>
<p>Cadwyn has an ability to migrate more than just request bodies.</p>
<p><code>RequestInfo</code> has the the following interfaces to migrate requests:</p>
<ul>
<li><code>body: Any</code></li>
<li><code>headers: starlette.datastructures.MutableHeaders</code></li>
<li><code>cookies: dict[str, str]</code></li>
<li><code>query_params: dict[str, str]</code></li>
</ul>
<p><code>ResponseInfo</code> has the the following interfaces to migrate responses:</p>
<ul>
<li><code>body: Any</code></li>
<li><code>status_code: int</code></li>
<li><code>headers: starlette.datastructures.MutableHeaders</code></li>
<li><a href="https://www.starlette.io/responses/#set-cookie">set_cookie</a></li>
<li><a href="https://www.starlette.io/responses/#delete-cookie">delete_cookie</a></li>
</ul>
<h5 id="internal-representations">Internal representations<a class="headerlink" href="#internal-representations" title="Permanent link">&para;</a></h5>
<p>We have only reviewed simplistic cases so far. But what happens when you cannot just migrate your data that easily? It can happen because your earlier versions had <strong>more data</strong> than your newer versions. Or that data had more formats.</p>
<p>Let's imagine that previously the <code>User</code> schema had a list of addresses but now we want to make a breaking change and turn them into a single address. The naive migration will just take the first address from the list for requests and turn that one address into a list for responses like so:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">cadwyn.structure</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">VersionChange</span><span class="p">,</span>
    <span class="n">schema</span><span class="p">,</span>
    <span class="n">convert_request_to_next_version_for</span><span class="p">,</span>
    <span class="n">convert_response_to_previous_version_for</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">data.latest.users</span> <span class="kn">import</span> <span class="n">User</span>

<span class="c1"># THIS IS AN EXAMPLE OF A BAD MIGRATION</span>
<span class="k">class</span> <span class="nc">RemoveTaxIDEndpoints</span><span class="p">(</span><span class="n">VersionChange</span><span class="p">):</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Users now have `address` field instead of `addresses`&quot;</span>
    <span class="n">instructions_to_migrate_to_previous_version</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">schema</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s2">&quot;address&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">didnt_exist</span><span class="p">,</span>
        <span class="n">schema</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s2">&quot;addresses&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">existed_as</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]),</span>
    <span class="p">)</span>

    <span class="nd">@convert_request_to_next_version_for</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">turn_addresses_into_a_single_item</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">RequestInfo</span><span class="p">):</span>
        <span class="n">addresses</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;addresses&quot;</span><span class="p">)</span>
        <span class="c1"># The list could have been empty in the past so new &quot;address&quot;</span>
        <span class="c1"># field must be nullable.</span>
        <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="s2">&quot;address&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">addresses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">addresses</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="nd">@convert_response_to_previous_version_for</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">turn_address_into_a_list</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">ResponseInfo</span><span class="p">):</span>
        <span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="s2">&quot;addresses&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;address&quot;</span><span class="p">)]</span>
</code></pre></div>
<p>But this will not work. Now when the user from the old version asks us to save three addresses, we will in fact save only one. Old data is also going to be affected -- if old users had multiple addresses, we will only be able to return one of them. This is bad -- we have made a breaking change!</p>
<p>In order to solve this problem, Cadwyn uses a concept of <strong>internal representations</strong>. An internal representation of your data is like a database entry of your data -- it is its <strong>latest</strong> version plus all the fields that are incompatible with the latest API version. If we were talking about classes, then internal representation would be a child of your latest schemas -- it has all the same data and a little more. Essentially your internal representation of user object can contain much more data than your latest schemas.</p>
<p>The <a href="#data-migrations">migrations diagram we showed before</a> is in fact a simplified version of truth. In fact, your requests do not get migrated to latest -- they get migrated to the <strong>internal representation</strong> of their data that is really similar to latest. Same happens with your responses -- you do not respond with and migrate from the latest version of your data, you respond with its <strong>internal representation</strong> which is really close to the actual latest schemas.</p>
<p>In responses, returning the internal representation is simple: just return your database model or a dict with everything you need for all your versions. In the user address example, we would continue storing the list of addresses in our database but then add the single address to our response. Latest schemas will simply strip it but our older schemas will be able to use it!</p>
<div class="highlight"><pre><span></span><code><span class="c1"># in your business logic</span>

<span class="k">return</span> <span class="p">{</span><span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">addresses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">addresses</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">user</span><span class="p">}</span>
</code></pre></div>
<p>So now your migration will look like the following:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">cadwyn.structure</span> <span class="kn">import</span> <span class="n">VersionChange</span><span class="p">,</span> <span class="n">schema</span>
<span class="kn">from</span> <span class="nn">data.latest.users</span> <span class="kn">import</span> <span class="n">User</span>


<span class="k">class</span> <span class="nc">RemoveTaxIDEndpoints</span><span class="p">(</span><span class="n">VersionChange</span><span class="p">):</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Users now have `address` field instead of `addresses`&quot;</span>
    <span class="n">instructions_to_migrate_to_previous_version</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">schema</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s2">&quot;address&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">didnt_exist</span><span class="p">,</span>
        <span class="n">schema</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s2">&quot;addresses&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">existed_as</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]),</span>
    <span class="p">)</span>
</code></pre></div>
<p>Yes, we do not need any of the migrations anymore because responses are handled automatically. But why don't we need request migrations? That's because we use an <strong>internal representation</strong> there too.</p>
<h5 id="internal-request-body-representations">Internal request body representations<a class="headerlink" href="#internal-request-body-representations" title="Permanent link">&para;</a></h5>
<p>Let's remember that our <code>User</code> model <a href="#internal-representations">had</a> multiple addresses in the old version but now has only one address in the new version. We <a href="#internal-representations">handled it in responses</a> by continuing to store the list of addresses and then returning all of them with each response. In requests, we have a similar trick. When you create the version with only one address, you need to define the internal representation of your user's creation request which will effectively store all addresses consistently for all versions instead of just one address:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># In data/unversioned/users.py</span>

<span class="kn">from</span> <span class="nn">.versioned_schemas.latest</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">root_validator</span><span class="p">,</span> <span class="n">PrivateAttr</span>


<span class="k">class</span> <span class="nc">InternalUserCreateRequest</span><span class="p">(</span><span class="n">User</span><span class="p">):</span>
    <span class="n">addresses</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="c1"># This helps us delete address from our fields</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">PrivateAttr</span><span class="p">()</span>

    <span class="nd">@root_validator</span><span class="p">(</span><span class="n">pre</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">move_address_from_latest_into_addresses</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;address&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">values</span><span class="p">[</span><span class="s2">&quot;addresses&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;address&quot;</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">values</span>
</code></pre></div>
<p>Whenever this model receives an <code>address</code>, it will add it into <code>addresses</code> so now our latest requests can also be converted into our internal representation. Now all that's left is to tell Cadwyn to wrap all requests into this schema. Let's go to the definition of <code>POST /v1/users</code></p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">cadwyn</span> <span class="kn">import</span> <span class="n">VersionedAPIRouter</span><span class="p">,</span> <span class="n">InternalRepresentationOf</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Annotated</span>
<span class="kn">from</span> <span class="nn">data.latest.users</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">data.unversioned.users</span> <span class="kn">import</span> <span class="n">InternalUserCreateRequest</span>

<span class="n">router</span> <span class="o">=</span> <span class="n">VersionedAPIRouter</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;/v1/users&quot;</span><span class="p">)</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">create_user</span><span class="p">(</span>
    <span class="n">payload</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span>
        <span class="n">InternalUserCreateRequest</span><span class="p">,</span> <span class="n">InternalRepresentationOf</span><span class="p">[</span><span class="n">User</span><span class="p">]</span>
    <span class="p">]</span>
<span class="p">):</span>
    <span class="o">...</span>
</code></pre></div>
<p>This type hint will tell Cadwyn that this route has public-facing schema of <code>User</code> that Cadwyn will use for validating all requests. Cadwyn will always use <code>InternalUserCreateRequest</code> when pushing body field into your business logic instead of <code>User</code>. Note that users will not be able to use any fields from the internal representation and their requests will still be validated by your regular schemas. So even if you added a field <code>foo</code> in an internal representation, and your user has passed this field in the body of the request, this field will not get to the internal representation because it will be removed at the moment of request validation (or even an error will occur if you use <code>extra="ignore"</code>). OpenAPI will also only use the public schemas, not the internal ones.</p>
<h5 id="streamingresponse-and-fileresponse-migrations">StreamingResponse and FileResponse migrations<a class="headerlink" href="#streamingresponse-and-fileresponse-migrations" title="Permanent link">&para;</a></h5>
<p>Migrations for the bodies of <code>fastapi.responses.StreamingResponse</code> and <code>fastapi.responses.FileResponse</code> are not directly supported yet (<a href="https://github.com/zmievsa/cadwyn/issues/125">1</a>, <a href="https://github.com/zmievsa/cadwyn/issues/126">2</a>). However, you can use <code>ResponseInfo._response</code> attribute to get access to the original <code>StreamingResponse</code> or <code>FileResponse</code> and modify it in any way you wish within your migrations.</p>
<h3 id="pydantic-2-rootmodel-migration-warning">Pydantic 2 RootModel migration warning<a class="headerlink" href="#pydantic-2-rootmodel-migration-warning" title="Permanent link">&para;</a></h3>
<p>Pydantic 2 has an interesting implementation detail: <code>pydantic.RootModel</code> instances are memoized. So the following code is going to output <code>True</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">data.latest.users</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">RootModel</span>

<span class="n">BulkCreateUsersRequestBody</span> <span class="o">=</span> <span class="n">RootModel</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">User</span><span class="p">]]</span>
<span class="n">BulkCreateUsersResponseBody</span> <span class="o">=</span> <span class="n">RootModel</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">User</span><span class="p">]]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">BulkCreateUsersRequestBody</span> <span class="ow">is</span> <span class="n">BulkCreateUsersResponseBody</span><span class="p">)</span>  <span class="c1"># True</span>
</code></pre></div>
<p>So if you make a migration that should only affect one of these schemas -- it will automatically affect both. A recommended alternative is to either use subclassing:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">data.latest.users</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">RootModel</span>

<span class="n">UserList</span> <span class="o">=</span> <span class="n">RootModel</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">User</span><span class="p">]]</span>


<span class="k">class</span> <span class="nc">BulkCreateUsersRequestBody</span><span class="p">(</span><span class="n">UserList</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">BulkCreateUsersResponseBody</span><span class="p">(</span><span class="n">UserList</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="nb">print</span><span class="p">(</span><span class="n">BulkCreateUsersRequestBody</span> <span class="ow">is</span> <span class="n">BulkCreateUsersResponseBody</span><span class="p">)</span>  <span class="c1"># False</span>
</code></pre></div>
<p>or to specify migrations using <a href="#path-based-migration-specification">endpoint path</a> instead of a schema.</p>
<h3 id="versionbundle">VersionBundle<a class="headerlink" href="#versionbundle" title="Permanent link">&para;</a></h3>
<p><code>VersionBundle</code> is your single source of truth for your list of versions. It contains your list of versions and all <a href="#version-changes">version changes</a> associated with them. Each version change is a single group of breaking changes. Each <code>Version</code> contains a group of version changes that caused this version to be created. So for example, if I deleted an endpoint <code>POST /v1/tax_ids</code> in version <code>2023-02-10</code>, then I'll add the version change for deleting that endpoint into <code>2023-02-10</code>. For example:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># versions/__init__.py</span>

<span class="kn">from</span> <span class="nn">cadwyn.structure</span> <span class="kn">import</span> <span class="n">VersionBundle</span><span class="p">,</span> <span class="n">Version</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>

<span class="kn">from</span> <span class="nn">.v2023_02_10</span> <span class="kn">import</span> <span class="n">RemoveTaxIDEndpoints</span>


<span class="n">versions</span> <span class="o">=</span> <span class="n">VersionBundle</span><span class="p">(</span>
    <span class="n">Version</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2023</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">RemoveTaxIDEndpoints</span><span class="p">),</span>
    <span class="n">Version</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">16</span><span class="p">)),</span>
<span class="p">)</span>
</code></pre></div>
<p>See how our first version, <code>2022-11-16</code> does not have any version changes? That is intentional! How can it have breaking changes if there are no versions before it?</p>
<h2 id="endpoints">Endpoints<a class="headerlink" href="#endpoints" title="Permanent link">&para;</a></h2>
<p>Note that the endpoint constructor contains a second argument that describes the methods of the endpoints you would like to edit. If you have two routes for a single endpoint and you put both of their methods into the instruction -- both of them are going to be changed as you would expect.</p>
<h3 id="defining-endpoints-that-didnt-exist-in-new-versions">Defining endpoints that didn't exist in new versions<a class="headerlink" href="#defining-endpoints-that-didnt-exist-in-new-versions" title="Permanent link">&para;</a></h3>
<p>If you had an endpoint in old version but do not have it in a new one, you must still define it but mark it as deleted.</p>
<div class="highlight"><pre><span></span><code><span class="nd">@router</span><span class="o">.</span><span class="n">only_exists_in_older_versions</span>
<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/my_old_endpoint&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">my_old_endpoint</span><span class="p">():</span>
    <span class="o">...</span>
</code></pre></div>
<p>and then define it as existing in one of the older versions:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">cadwyn.structure</span> <span class="kn">import</span> <span class="n">VersionChange</span><span class="p">,</span> <span class="n">endpoint</span>


<span class="k">class</span> <span class="nc">MyChange</span><span class="p">(</span><span class="n">VersionChange</span><span class="p">):</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;...&quot;</span>
    <span class="n">instructions_to_migrate_to_previous_version</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">endpoint</span><span class="p">(</span><span class="s2">&quot;/my_old_endpoint&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">existed</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
<h3 id="defining-endpoints-that-didnt-exist-in-old-versions">Defining endpoints that didn't exist in old versions<a class="headerlink" href="#defining-endpoints-that-didnt-exist-in-old-versions" title="Permanent link">&para;</a></h3>
<p>If you have an endpoint in your new version that must not exist in older versions, you define it as usual and then mark it as "non-existing" in old versions:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">cadwyn.structure</span> <span class="kn">import</span> <span class="n">VersionChange</span><span class="p">,</span> <span class="n">endpoint</span>


<span class="k">class</span> <span class="nc">MyChange</span><span class="p">(</span><span class="n">VersionChange</span><span class="p">):</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;...&quot;</span>
    <span class="n">instructions_to_migrate_to_previous_version</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">endpoint</span><span class="p">(</span><span class="s2">&quot;/my_new_endpoint&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">didnt_exist</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
<h3 id="changing-endpoint-attributes">Changing endpoint attributes<a class="headerlink" href="#changing-endpoint-attributes" title="Permanent link">&para;</a></h3>
<p>If you want to change any attribute of your endpoint in a new version, you can return the attribute's value in all older versions like so:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">cadwyn.structure</span> <span class="kn">import</span> <span class="n">VersionChange</span><span class="p">,</span> <span class="n">endpoint</span>


<span class="k">class</span> <span class="nc">MyChange</span><span class="p">(</span><span class="n">VersionChange</span><span class="p">):</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;...&quot;</span>
    <span class="n">instructions_to_migrate_to_previous_version</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">endpoint</span><span class="p">(</span><span class="s2">&quot;/my_endpoint&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">had</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;My old description&quot;</span><span class="p">),</span>
    <span class="p">)</span>
</code></pre></div>
<h3 id="dealing-with-endpoint-duplicates">Dealing with endpoint duplicates<a class="headerlink" href="#dealing-with-endpoint-duplicates" title="Permanent link">&para;</a></h3>
<p>Sometimes, when you're doing some advanced changes in between versions, you will need to rewrite your endpoint function entirely. So essentially you'd have the following structure:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">fastapi.params</span> <span class="kn">import</span> <span class="n">Param</span>
<span class="kn">from</span> <span class="nn">fastapi.headers</span> <span class="kn">import</span> <span class="n">Header</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Annotated</span>
<span class="kn">from</span> <span class="nn">cadwyn</span> <span class="kn">import</span> <span class="n">VersionedAPIRouter</span>

<span class="n">router</span> <span class="o">=</span> <span class="n">VersionedAPIRouter</span><span class="p">()</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">only_exists_in_older_versions</span>
<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_users_by_name_before_we_started_using_params</span><span class="p">(</span>
    <span class="n">user_name</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Header</span><span class="p">()]</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Do some logic with user_name&quot;&quot;&quot;</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_users_by_name</span><span class="p">(</span><span class="n">user_name</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Param</span><span class="p">()]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Do some logic with user_name&quot;&quot;&quot;</span>
</code></pre></div>
<p>As you see, these two functions have the same methods and paths. And when you have many versions, you can have even more functions like these two. So how do we ask cadwyn to restore only one of them and delete the other one?</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">cadwyn.structure</span> <span class="kn">import</span> <span class="n">VersionChange</span><span class="p">,</span> <span class="n">endpoint</span>


<span class="k">class</span> <span class="nc">UseParamsInsteadOfHeadersForUserNameFiltering</span><span class="p">(</span><span class="n">VersionChange</span><span class="p">):</span>
    <span class="n">description</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Use params instead of headers for user name filtering in GET /users &quot;</span>
        <span class="s2">&quot;because using headers is a bad API practice in such scenarios.&quot;</span>
    <span class="p">)</span>
    <span class="n">instructions_to_migrate_to_previous_version</span> <span class="o">=</span> <span class="p">(</span>
        <span class="c1"># We don&#39;t have to specify the name here because there&#39;s only one such deleted endpoint</span>
        <span class="n">endpoint</span><span class="p">(</span><span class="s2">&quot;/users&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">existed</span><span class="p">,</span>
        <span class="c1"># We do have to specify the name because we now have two existing endpoints after the instruction above</span>
        <span class="n">endpoint</span><span class="p">(</span>
            <span class="s2">&quot;/users&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">],</span> <span class="n">endpoint_func_name</span><span class="o">=</span><span class="s2">&quot;get_users_by_name&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">didnt_exist</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
<p>So by using a more concrete <code>endpoint_func_name</code>, we are capable to distinguish between different functions that affect the same routes.</p>
<h2 id="enums">Enums<a class="headerlink" href="#enums" title="Permanent link">&para;</a></h2>
<p>All of the following instructions affect only code generation.</p>
<h3 id="adding-enum-members">Adding enum members<a class="headerlink" href="#adding-enum-members" title="Permanent link">&para;</a></h3>
<p>Note that adding enum members <strong>can</strong> be a breaking change unlike adding optional fields to a schema. For example, if I return a list of entities, each of which has some type, and I add a new type -- then my client's code is likely to break.</p>
<p>So I suggest adding enum members in new versions as well.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">cadwyn.structure</span> <span class="kn">import</span> <span class="n">VersionChange</span><span class="p">,</span> <span class="n">enum</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">auto</span>


<span class="k">class</span> <span class="nc">MyChange</span><span class="p">(</span><span class="n">VersionChange</span><span class="p">):</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;...&quot;</span>
    <span class="n">instructions_to_migrate_to_previous_version</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">enum</span><span class="p">(</span><span class="n">my_enum</span><span class="p">)</span><span class="o">.</span><span class="n">had</span><span class="p">(</span><span class="n">foo</span><span class="o">=</span><span class="s2">&quot;baz&quot;</span><span class="p">,</span> <span class="n">bar</span><span class="o">=</span><span class="n">auto</span><span class="p">()),</span>
    <span class="p">)</span>
</code></pre></div>
<h3 id="removing-enum-members">Removing enum members<a class="headerlink" href="#removing-enum-members" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">cadwyn.structure</span> <span class="kn">import</span> <span class="n">VersionChange</span><span class="p">,</span> <span class="n">enum</span>


<span class="k">class</span> <span class="nc">MyChange</span><span class="p">(</span><span class="n">VersionChange</span><span class="p">):</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;...&quot;</span>
    <span class="n">instructions_to_migrate_to_previous_version</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">enum</span><span class="p">(</span><span class="n">my_enum</span><span class="p">)</span><span class="o">.</span><span class="n">didnt_have</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="s2">&quot;bar&quot;</span><span class="p">),</span>
    <span class="p">)</span>
</code></pre></div>
<h2 id="schemas">Schemas<a class="headerlink" href="#schemas" title="Permanent link">&para;</a></h2>
<p>All of the following instructions affect only code generation.</p>
<h3 id="add-a-field">Add a field<a class="headerlink" href="#add-a-field" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">Field</span>
<span class="kn">from</span> <span class="nn">cadwyn.structure</span> <span class="kn">import</span> <span class="n">VersionChange</span><span class="p">,</span> <span class="n">schema</span>


<span class="k">class</span> <span class="nc">MyChange</span><span class="p">(</span><span class="n">VersionChange</span><span class="p">):</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;...&quot;</span>
    <span class="n">instructions_to_migrate_to_previous_version</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">schema</span><span class="p">(</span><span class="n">MySchema</span><span class="p">)</span>
        <span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">existed_as</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">info</span><span class="o">=</span><span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Foo&quot;</span><span class="p">)),</span>
    <span class="p">)</span>
</code></pre></div>
<p>You can also specify any string in place of type:</p>
<div class="highlight"><pre><span></span><code><span class="n">schema</span><span class="p">(</span><span class="n">MySchema</span><span class="p">)</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">existed_as</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;AnythingHere&quot;</span><span class="p">)</span>
</code></pre></div>
<p>It is often the case that you want to add a type that has not been imported in your schemas yet. You can use <a href="#modules">module import adding</a> to solve this issue.</p>
<h3 id="remove-a-field">Remove a field<a class="headerlink" href="#remove-a-field" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">cadwyn.structure</span> <span class="kn">import</span> <span class="n">VersionChange</span><span class="p">,</span> <span class="n">schema</span>


<span class="k">class</span> <span class="nc">MyChange</span><span class="p">(</span><span class="n">VersionChange</span><span class="p">):</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;...&quot;</span>
    <span class="n">instructions_to_migrate_to_previous_version</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">schema</span><span class="p">(</span><span class="n">MySchema</span><span class="p">)</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">didnt_exist</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
<h3 id="change-a-field">Change a field<a class="headerlink" href="#change-a-field" title="Permanent link">&para;</a></h3>
<p>If you would like to set a description or any other attribute of a field, you would do:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">cadwyn.structure</span> <span class="kn">import</span> <span class="n">VersionChange</span><span class="p">,</span> <span class="n">schema</span>


<span class="k">class</span> <span class="nc">MyChange</span><span class="p">(</span><span class="n">VersionChange</span><span class="p">):</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;...&quot;</span>
    <span class="n">instructions_to_migrate_to_previous_version</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">schema</span><span class="p">(</span><span class="n">MySchema</span><span class="p">)</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">had</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Foo&quot;</span><span class="p">),</span>
    <span class="p">)</span>
</code></pre></div>
<p>and if you would like to unset any attribute of a field as if it was never passed, you would do:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">cadwyn.structure</span> <span class="kn">import</span> <span class="n">VersionChange</span><span class="p">,</span> <span class="n">schema</span>


<span class="k">class</span> <span class="nc">MyChange</span><span class="p">(</span><span class="n">VersionChange</span><span class="p">):</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;...&quot;</span>
    <span class="n">instructions_to_migrate_to_previous_version</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">schema</span><span class="p">(</span><span class="n">MySchema</span><span class="p">)</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">didnt_have</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">),</span>
    <span class="p">)</span>
</code></pre></div>
<h4 id="defaults-warning"><strong>DEFAULTS WARNING</strong><a class="headerlink" href="#defaults-warning" title="Permanent link">&para;</a></h4>
<p>If you add <code>default</code> or <code>default_factory</code> into the old version of a schema -- it will not manifest in code automatically. Instead, you should add both the <code>default</code> or <code>default_factory</code>, and then also add the default value using a request migration.</p>
<p>This happens because of how Cadwyn works with pydantic and sadly cannot be changed:</p>
<p>Cadwyn:</p>
<ol>
<li>Receives the request of some version <code>V</code></li>
<li>Validates the request using the schemas from <code>V</code></li>
<li>Marshalls the unmarshalled request body into a raw data structure using <code>BaseModel.dict</code> (<code>BaseModel.model_dump</code> in Pydantic v2) using <strong>exclude_unset=True</strong></li>
<li>Passes the request through all request migrations from <code>V</code> to <code>latest</code></li>
<li>Validates the request using <code>latest</code> schemas</li>
</ol>
<p>The part that causes the aforementioned problem is our usage of <code>exclude_unset=True</code>. Sadly, when we use it, all default fields do not get set so <code>latest</code> does not receive them. And if <code>latest</code> does not have the same defaults (for example, if the field has no default and is required in <code>latest</code>), then an error will occur. If we used <code>exclude_unset=False</code>, then <code>exclude_unset</code> would lose all its purpose for the users of our library so we cannot abandon it. Instead, you should set all extra on step 4 in your request migrations.</p>
<h3 id="add-a-validator">Add a validator<a class="headerlink" href="#add-a-validator" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">Field</span><span class="p">,</span> <span class="n">validator</span>
<span class="kn">from</span> <span class="nn">cadwyn.structure</span> <span class="kn">import</span> <span class="n">VersionChange</span><span class="p">,</span> <span class="n">schema</span>


<span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">validate_foo</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span>
    <span class="k">return</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">MyChange</span><span class="p">(</span><span class="n">VersionChange</span><span class="p">):</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;...&quot;</span>
    <span class="n">instructions_to_migrate_to_previous_version</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">schema</span><span class="p">(</span><span class="n">MySchema</span><span class="p">)</span><span class="o">.</span><span class="n">validator</span><span class="p">(</span><span class="n">validate_foo</span><span class="p">)</span><span class="o">.</span><span class="n">existed</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
<h3 id="remove-a-validator">Remove a validator<a class="headerlink" href="#remove-a-validator" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">Field</span><span class="p">,</span> <span class="n">validator</span>
<span class="kn">from</span> <span class="nn">cadwyn.structure</span> <span class="kn">import</span> <span class="n">VersionChange</span><span class="p">,</span> <span class="n">schema</span>


<span class="k">class</span> <span class="nc">MyChange</span><span class="p">(</span><span class="n">VersionChange</span><span class="p">):</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;...&quot;</span>
    <span class="n">instructions_to_migrate_to_previous_version</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">schema</span><span class="p">(</span><span class="n">MySchema</span><span class="p">)</span><span class="o">.</span><span class="n">validator</span><span class="p">(</span><span class="n">MySchema</span><span class="o">.</span><span class="n">validate_foo</span><span class="p">)</span><span class="o">.</span><span class="n">didnt_exist</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
<h3 id="rename-a-schema">Rename a schema<a class="headerlink" href="#rename-a-schema" title="Permanent link">&para;</a></h3>
<p>If you wish to rename your schema to make sure that its name is different in openapi.json:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">cadwyn.structure</span> <span class="kn">import</span> <span class="n">VersionChange</span><span class="p">,</span> <span class="n">schema</span>


<span class="k">class</span> <span class="nc">MyChange</span><span class="p">(</span><span class="n">VersionChange</span><span class="p">):</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;...&quot;</span>
    <span class="n">instructions_to_migrate_to_previous_version</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">schema</span><span class="p">(</span><span class="n">MySchema</span><span class="p">)</span><span class="o">.</span><span class="n">had</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;OtherSchema&quot;</span><span class="p">),</span>
    <span class="p">)</span>
</code></pre></div>
<p>which will replace all references to this schema with the new name.</p>
<h2 id="modules">Modules<a class="headerlink" href="#modules" title="Permanent link">&para;</a></h2>
<p>Oftentimes you start depending on new types in-between versions. For example, let's say that you depended on <code>Invoice</code> schema within your <code>data.latest.users</code> in older versions but now you do not. This means that once we run code generation and this type gets back into some annotation of some schema in <code>data.latest.users</code> -- it will not be imported because it was not imported in <code>latest</code>. To solve problems like this one, we have <code>module</code> instructions:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">cadwyn.structure</span> <span class="kn">import</span> <span class="n">VersionChange</span><span class="p">,</span> <span class="n">module</span>
<span class="kn">import</span> <span class="nn">data.latest.users</span>


<span class="k">class</span> <span class="nc">MyChange</span><span class="p">(</span><span class="n">VersionChange</span><span class="p">):</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;...&quot;</span>
    <span class="n">instructions_to_migrate_to_previous_version</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">module</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">latest</span><span class="o">.</span><span class="n">users</span><span class="p">)</span><span class="o">.</span><span class="n">had</span><span class="p">(</span><span class="n">import_</span><span class="o">=</span><span class="s2">&quot;from .invoices import Invoice&quot;</span><span class="p">),</span>
    <span class="p">)</span>
</code></pre></div>
<p>Which will add-in this import at the top of <code>users</code> file in all versions before this version change.</p>
<h2 id="version-changes-with-side-effects">Version changes with side effects<a class="headerlink" href="#version-changes-with-side-effects" title="Permanent link">&para;</a></h2>
<p>Sometimes you will use API versioning to handle a breaking change in your <strong>business logic</strong>, not in the schemas themselves. In such cases, it is tempting to add a version check and just follow the new business logic such as:</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="n">api_version_var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">date</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
    <span class="c1"># do new logic here</span>
    <span class="o">...</span>
</code></pre></div>
<p>In cadwyn, this approach is <strong>highly</strong> discouraged. It is recommended that you avoid side effects like this at any cost because each one makes your core logic harder to understand. But if you cannot, then I urge you to at least abstract away versions and versioning from your business logic which will make your code much easier to read.</p>
<p><strong>WARNING</strong>: Side effects are the wrong way to do API Versioning. In 99% of time, you will <strong>not</strong> need them. Please, think twice before using them. API Versioning is about having the same underlying app and data while just changing the schemas and api endpoints to interact with it. By introducing side effects, you leak versioning into your business logic and possibly even your data which makes your code much harder to support in the long term. If each side effect adds a single <code>if</code> to your logic, than after 100 versions with side effects, you will have 100 more <code>if</code>s. If used correctly, Cadwyn can help you support decades worth of API versions at the same time with minimal costs but side effects make it much harder to do. Changes in the underlying source, structure, or logic of your data should not affect your API or public-facing business logic.</p>
<p>To simplify this, cadwyn has a special <code>VersionChangeWithSideEffects</code> class. It makes finding dangerous versions that have side effects much easier and provides a nice abstraction for checking whether we are on a version where these side effects have been applied.</p>
<p>As an example, let's use the tutorial section's case with the user and their address. Let's say that we use an external service to check whether user's address is listed in it and return 400 response if it is not. Let's also say that we only added this check in the newest version.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">cadwyn.structure</span> <span class="kn">import</span> <span class="n">VersionChangeWithSideEffects</span>


<span class="k">class</span> <span class="nc">UserAddressIsCheckedInExternalService</span><span class="p">(</span><span class="n">VersionChangeWithSideEffects</span><span class="p">):</span>
    <span class="n">description</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;User&#39;s address is now checked for existense in an external service. &quot;</span>
        <span class="s2">&quot;If it doesn&#39;t exist there, a 400 code is returned.&quot;</span>
    <span class="p">)</span>
</code></pre></div>
<p>Then we will have the following check in our business logic:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">src.versions</span> <span class="kn">import</span> <span class="n">versions</span><span class="p">,</span> <span class="n">UserAddressIsCheckedInExternalService</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">create_user</span><span class="p">(</span><span class="n">payload</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">UserAddressIsCheckedInExternalService</span><span class="o">.</span><span class="n">is_applied</span><span class="p">:</span>
        <span class="n">check_user_address_exists_in_an_external_service</span><span class="p">(</span><span class="n">payload</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
    <span class="o">...</span>
</code></pre></div>
<p>So this change can be contained in any version -- your business logic doesn't know which version it has and shouldn't.</p>
<h2 id="api-version-header-and-context-variables">API Version header and context variables<a class="headerlink" href="#api-version-header-and-context-variables" title="Permanent link">&para;</a></h2>
<p>Cadwyn automatically converts your data to a correct version and has "version checks" when dealing with side effects as described in <a href="#version-changes-with-side-effects">the section above</a>. It can only do so using a special <a href="https://docs.python.org/3/library/contextvars.html">context variable</a> that stores the current API version.</p>
<p>You can also pass a different compatible contextvar to your <code>cadwyn.VersionBundle</code> constructor.</p>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["search.suggest", "search.highlight", "content.tabs.link", "navigation.indexes", "navigation.tracking", "navigation.tabs", "navigation.path", "content.tooltips", "content.code.annotate", "content.code.copy", "content.code.select"], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.caa56a14.min.js"></script>
      
    
  </body>
</html>